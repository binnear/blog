之前在公司项目中实现了一个可配置的转盘抽奖，主要是用canvas进行绘制，写这篇文章是为了通过一个大家可能会感兴趣的点，来熟悉canvas的一些api，我自己也算是进行一些复习。😁
  
进入正题：首先我们分析一下需求，实现一个可配置的转盘抽奖，可以先分割为两个需求，一是实现一个转盘抽奖，二是转盘可配置。

## 一、实现一个转盘抽奖

在实现之前我们要有一个整体的思路，回想一下，我们曾经在网上或者现实中见过的抽奖转盘都有那些元素：

* 一个大的转盘
* 转盘上有一个个区间，表示不同的奖品
* 在转盘的中间有一个按钮，按钮上有一个指针，来指向抽中的奖品

我们再想想抽奖的过程：当我们点击中间的按钮，转盘开始旋转，当获取到奖品后，旋转的速度从快到慢，缓缓停下，最后指向奖品所在的那个区域，我们的实现步骤就可以这样

- 绘制所有的静态元素
- 给转盘添加旋转动画
- 指针所指区域为我们指定的奖品

### 1.绘制所有静态元素

#### 1.1.开发环境搭建

全局安装`create-react-app`，快速生成`react`的开发环境，这个与我们要开发的转盘没有耦合关系，只是为了方便调试，用`vue`也是可以的。

```javascript
// 全局安装
npm install create-react-app -g

// 生成开发环境，lottery为目录名
create-react-app lottery
```
安装完成后修改成如下图目录结构
  
![](https://user-gold-cdn.xitu.io/2018/10/14/16672136c078fe2c?w=525&h=324&f=png&s=20740)

`turntable.jsx`内容如下：

```javascript
export default class Turntable {
}
```

`App.js`内容如下：

```javascript
import React, { Component } from 'react'
import Turntable from './turntable/turntable'
class App extends Component {
  constructor(props) {
    super(props)
  }
  render() {
    return <div>抽奖转盘</div>
  }
}
export default App
```

完成以上工作后，在当前目录打开命令行工具，输入`npm start`启动项目

#### 1.2.绘制大转盘

修改`App.js`中的内容如下:

```javascript
import React, { Component } from 'react'
import Turntable from './turntable/turntable'
class App extends Component {
  constructor(props) {
    super(props)
    // react中获取dom元素
    this.canvas = React.createRef()
  }
  componentDidMount() {
    // canvas元素保存在this.canvas的current属性中
    const canvas = this.canvas.current
    // 获取canvas的上下文,context含有各种api用来操作canvas
    const context = canvas.getContext('2d')
    // 设置canvas的宽高
    canvas.width = 300
    canvas.height = 300
    // 创建turntable对象,并将canvas元素和context传入
    const turntable = new Turntable({canvas: canvas, context: context})
    turntable.render()
  }
  render() {
    return <canvas
      ref={this.canvas}
      style={{
        width: '300px',
        height: '300px',
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        margin: 'auto'
      }}>
    </canvas>
  }
}
export default App
```

修改`turntable.jsx`中的内容:

```javascript
export default class Turntable {
  constructor(options) {
    // 获取并保存传入的canvas,context
    this.canvas = options.canvas
    this.context = options.context
  }
  drawPanel() {
    const context = this.context
    // 保存当前画布的状态,使用restore调用后,保证了当前绘制不受之前绘制的影响
    context.save()
    // 新建一个路径,画笔的位置回到默认的坐标(0,0)的位置,保证了当前的绘制不会影响到之前的绘制
		context.beginPath()
    // 设置填充转盘用的颜色,fill是填充而不是绘制.
    context.fillStyle = '#FD6961'
    // 绘制一个圆,有六个参数,分别表示:圆心的x坐标,圆心的y坐标,圆的半径,开始绘制的角度,结束的角度,绘制方向(false表示顺时针)
    context.arc(150, 150, 150, 0, Math.PI * 2, false)
    // 将我们设置的颜色填充到圆中,这里不用closePath是因为closePath对fill无效.
    context.fill()
    // 将画布的状态恢复到我们上一次save()时的状态
    context.restore()
  } 
  render() {
		this.drawPanel()
	}
}
```

保存后,浏览器中结果显示如下图:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/16672f7ef2327125?w=887&h=451&f=png&s=14715)

#### 1.2.绘制奖品块

在`turntable.jsx`文件中的`Turntable`类中添加和修改内容如下(为了避免重复内容导致篇幅过长,所有不变的部分都不会展示):

```javascript
// add
drawPrizeBlock() {
  const context = this.context
  // 第一个奖品色块开始绘制时开始的弧度及结束的弧度,因为我们这里暂时固定设置为6个奖品,所以以6为基数
  let startRadian = 0, RadianGap = Math.PI * 2 / 6, endRadian = startRadian + RadianGap
  for (let i = 0; i < 6; i++) {
    context.save()
    context.beginPath()
    // 为了区分不同的色块,我们使用随机生成的颜色作为色块的填充色
    context.fillStyle = '#'+Math.floor(Math.random()*16777215).toString(16)
    // 这里需要使用moveTo方法将初始位置定位在圆点处,这样绘制的圆弧都会以圆点作为闭合点,下面有使用moveTo和不使用moveTo的对比图
    context.moveTo(150, 150)
    // 画圆弧时,每次都会自动调用moveTo,将画笔移动到圆弧的起点,半径我们设置的比转盘稍小一点
    context.arc(150, 150, 140, startRadian, endRadian, false)
    // 每个奖品色块绘制完后,下个奖品的弧度会递增
    startRadian += RadianGap
    endRadian += RadianGap
    context.fill()
    context.restore()
  }
}
// modify
render() {
  this.drawPanel()
  this.drawPrizeBlock()
}
```

保存后,我们的转盘变为如下图样式:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/166730141b370137?w=887&h=451&f=png&s=24686)

使用绘制奖品色块使用`context.moveTo(150, 150)`和不使用的区别:

使用了`context.moveTo(150, 150)`:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/1667307ebb51d650?w=887&h=451&f=png&s=37248)

没有使用`context.moveTo(150, 150)`:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/166730ae7602e398?w=887&h=451&f=png&s=36050)

奖品块绘制好了,我们需要添加每个奖品的名称,以及奖品的图片,假定我们有三个奖品,另外三个就设置为未中奖

修改`drawPrizeBlock`方法如下:

```javascript

```