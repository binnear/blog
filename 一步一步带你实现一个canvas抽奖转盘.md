ä¹‹å‰åœ¨å…¬å¸é¡¹ç›®ä¸­å®ç°äº†ä¸€ä¸ªå¯é…ç½®çš„è½¬ç›˜æŠ½å¥–ï¼Œä¸»è¦æ˜¯ç”¨canvasè¿›è¡Œç»˜åˆ¶ï¼Œå†™è¿™ç¯‡æ–‡ç« æ˜¯ä¸ºäº†é€šè¿‡ä¸€ä¸ªå¤§å®¶å¯èƒ½ä¼šæ„Ÿå…´è¶£çš„ç‚¹ï¼Œæ¥ç†Ÿæ‚‰canvasçš„ä¸€äº›apiï¼Œæˆ‘è‡ªå·±ä¹Ÿç®—æ˜¯è¿›è¡Œä¸€äº›å¤ä¹ ï¼Œå½“ç„¶æ–‡ç« ä¸ä¼šåƒé¡¹ç›®ä¸­å®ç°çš„é‚£æ ·å¤æ‚ï¼Œåªæ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„ï¼Œå°½é‡åšåˆ°é€šä¿—æ˜“æ‡‚ï¼Œç»™æ„Ÿå…´è¶£çš„ä½ æŒ‡å¼•ä¸€æ¡è·¯ï¼ˆå…¶å®æ˜¯æ‡’~ï¼‰ã€‚ğŸ˜

## ä¸€ã€å®ç°ä¸€ä¸ªè½¬ç›˜æŠ½å¥–

åœ¨å®ç°ä¹‹å‰æˆ‘ä»¬è¦æœ‰ä¸€ä¸ªæ•´ä½“çš„æ€è·¯ï¼Œå›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ›¾ç»åœ¨ç½‘ä¸Šæˆ–è€…ç°å®ä¸­è§è¿‡çš„æŠ½å¥–è½¬ç›˜éƒ½æœ‰é‚£äº›å…ƒç´ ï¼š

* ä¸€ä¸ªå¤§çš„è½¬ç›˜
* è½¬ç›˜ä¸Šæœ‰ä¸€ä¸ªä¸ªåŒºé—´ï¼Œè¡¨ç¤ºä¸åŒçš„å¥–å“
* åœ¨è½¬ç›˜çš„ä¸­é—´æœ‰ä¸€ä¸ªæŒ‰é’®ï¼ŒæŒ‰é’®ä¸Šæœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œæ¥æŒ‡å‘æŠ½ä¸­çš„å¥–å“

æˆ‘ä»¬å†æƒ³æƒ³æŠ½å¥–çš„è¿‡ç¨‹ï¼šå½“æˆ‘ä»¬ç‚¹å‡»ä¸­é—´çš„æŒ‰é’®ï¼Œè½¬ç›˜å¼€å§‹æ—‹è½¬ï¼Œå½“è·å–åˆ°å¥–å“åï¼Œæ—‹è½¬çš„é€Ÿåº¦ä»å¿«åˆ°æ…¢ï¼Œç¼“ç¼“åœä¸‹ï¼Œæœ€åæŒ‡å‘å¥–å“æ‰€åœ¨çš„é‚£ä¸ªåŒºåŸŸï¼Œæˆ‘ä»¬çš„å®ç°æ­¥éª¤å°±å¯ä»¥è¿™æ ·

- ç»˜åˆ¶æ‰€æœ‰çš„é™æ€å…ƒç´ 
- ç»™è½¬ç›˜æ·»åŠ æ—‹è½¬åŠ¨ç”»
- æŒ‡é’ˆæ‰€æŒ‡åŒºåŸŸä¸ºæˆ‘ä»¬æŒ‡å®šçš„å¥–å“

### 1.ç»˜åˆ¶æ‰€æœ‰é™æ€å…ƒç´ 

#### 1.1.å¼€å‘ç¯å¢ƒæ­å»º

å…¨å±€å®‰è£…`create-react-app`ï¼Œå¿«é€Ÿç”Ÿæˆ`react`çš„å¼€å‘ç¯å¢ƒï¼Œè¿™ä¸ªä¸æˆ‘ä»¬è¦å¼€å‘çš„è½¬ç›˜æ²¡æœ‰è€¦åˆå…³ç³»ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œç”¨`vue`ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

```javascript
// å…¨å±€å®‰è£…
npm install create-react-app -g

// ç”Ÿæˆå¼€å‘ç¯å¢ƒï¼Œlotteryä¸ºç›®å½•å
create-react-app lottery
```
å®‰è£…å®Œæˆåä¿®æ”¹æˆå¦‚ä¸‹å›¾ç›®å½•ç»“æ„
  
![](https://user-gold-cdn.xitu.io/2018/10/14/16672136c078fe2c?w=525&h=324&f=png&s=20740)

`turntable.jsx`å†…å®¹å¦‚ä¸‹ï¼š

```javascript
export default class Turntable {
}
```

`App.js`å†…å®¹å¦‚ä¸‹ï¼š

```javascript
import React, { Component } from 'react'
import Turntable from './turntable/turntable'
class App extends Component {
  constructor(props) {
    super(props)
  }
  render() {
    return <div>æŠ½å¥–è½¬ç›˜</div>
  }
}
export default App
```

å®Œæˆä»¥ä¸Šå·¥ä½œåï¼Œåœ¨å½“å‰ç›®å½•æ‰“å¼€å‘½ä»¤è¡Œå·¥å…·ï¼Œè¾“å…¥`npm start`å¯åŠ¨é¡¹ç›®

#### 1.2.ç»˜åˆ¶å¤§è½¬ç›˜

ä¿®æ”¹`App.js`ä¸­çš„å†…å®¹å¦‚ä¸‹:

```javascript
import React, { Component } from 'react'
import Turntable from './turntable/turntable'
class App extends Component {
  constructor(props) {
    super(props)
    // reactä¸­è·å–domå…ƒç´ 
    this.canvas = React.createRef()
  }
  componentDidMount() {
    // canvaså…ƒç´ ä¿å­˜åœ¨this.canvasçš„currentå±æ€§ä¸­
    const canvas = this.canvas.current
    // è·å–canvasçš„ä¸Šä¸‹æ–‡,contextå«æœ‰å„ç§apiç”¨æ¥æ“ä½œcanvas
    const context = canvas.getContext('2d')
    // è®¾ç½®canvasçš„å®½é«˜
    canvas.width = 300
    canvas.height = 300
    // åˆ›å»ºturntableå¯¹è±¡,å¹¶å°†canvaså…ƒç´ å’Œcontextä¼ å…¥
    const turntable = new Turntable({canvas: canvas, context: context})
    turntable.render()
  }
  render() {
    return <canvas
      ref={this.canvas}
      style={{
        width: '300px',
        height: '300px',
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        margin: 'auto'
      }}>
    </canvas>
  }
}
export default App
```

ä¿®æ”¹`turntable.jsx`ä¸­çš„å†…å®¹:

```javascript
export default class Turntable {
  constructor(options) {
    // è·å–å¹¶ä¿å­˜ä¼ å…¥çš„canvas,context
    this.canvas = options.canvas
    this.context = options.context
  }
  drawPanel() {
    const context = this.context
    // ä¿å­˜å½“å‰ç”»å¸ƒçš„çŠ¶æ€,ä½¿ç”¨restoreè°ƒç”¨å,ä¿è¯äº†å½“å‰
    // ç»˜åˆ¶ä¸å—ä¹‹å‰ç»˜åˆ¶çš„å½±å“
    context.save()
    // æ–°å»ºä¸€ä¸ªè·¯å¾„,ç”»ç¬”çš„ä½ç½®å›åˆ°é»˜è®¤çš„åæ ‡(0,0)çš„ä½ç½®
    // ä¿è¯äº†å½“å‰çš„ç»˜åˆ¶ä¸ä¼šå½±å“åˆ°ä¹‹å‰çš„ç»˜åˆ¶
		context.beginPath()
    // è®¾ç½®å¡«å……è½¬ç›˜ç”¨çš„é¢œè‰²,fillæ˜¯å¡«å……è€Œä¸æ˜¯ç»˜åˆ¶.
    context.fillStyle = '#FD6961'
    // ç»˜åˆ¶ä¸€ä¸ªåœ†,æœ‰å…­ä¸ªå‚æ•°,åˆ†åˆ«è¡¨ç¤º:åœ†å¿ƒçš„xåæ ‡,åœ†å¿ƒçš„
    // yåæ ‡,åœ†çš„åŠå¾„,å¼€å§‹ç»˜åˆ¶çš„è§’åº¦,ç»“æŸçš„è§’åº¦,ç»˜åˆ¶æ–¹å‘
    // (falseè¡¨ç¤ºé¡ºæ—¶é’ˆ)
    context.arc(150, 150, 150, 0, Math.PI * 2, false)
    // å°†æˆ‘ä»¬è®¾ç½®çš„é¢œè‰²å¡«å……åˆ°åœ†ä¸­,è¿™é‡Œä¸ç”¨closePathæ˜¯å› 
    // ä¸ºclosePathå¯¹fillæ— æ•ˆ.
    context.fill()
    // å°†ç”»å¸ƒçš„çŠ¶æ€æ¢å¤åˆ°æˆ‘ä»¬ä¸Šä¸€æ¬¡save()æ—¶çš„çŠ¶æ€
    context.restore()
  } 
  render() {
		this.drawPanel()
	}
}
```

ä¿å­˜å,æµè§ˆå™¨ä¸­ç»“æœæ˜¾ç¤ºå¦‚ä¸‹å›¾:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/16672f7ef2327125?w=887&h=451&f=png&s=14715)

#### 1.2.ç»˜åˆ¶å¥–å“å—

åœ¨`turntable.jsx`æ–‡ä»¶ä¸­çš„`Turntable`ç±»ä¸­æ·»åŠ å’Œä¿®æ”¹å†…å®¹å¦‚ä¸‹(ä¸ºäº†é¿å…é‡å¤å†…å®¹å¯¼è‡´ç¯‡å¹…è¿‡é•¿,æ‰€æœ‰ä¸å˜çš„éƒ¨åˆ†éƒ½ä¸ä¼šå±•ç¤º):

```javascript
// add
drawPrizeBlock() {
  const context = this.context
  // ç¬¬ä¸€ä¸ªå¥–å“è‰²å—å¼€å§‹ç»˜åˆ¶æ—¶å¼€å§‹çš„å¼§åº¦åŠç»“æŸçš„å¼§åº¦,å› ä¸ºæˆ‘ä»¬è¿™é‡Œ
  // æš‚æ—¶å›ºå®šè®¾ç½®ä¸º6ä¸ªå¥–å“,æ‰€ä»¥ä»¥6ä¸ºåŸºæ•°
  let startRadian = 0, RadianGap = Math.PI * 2 / 6, endRadian = startRadian + RadianGap
  for (let i = 0; i < 6; i++) {
    context.save()
    context.beginPath()
    // ä¸ºäº†åŒºåˆ†ä¸åŒçš„è‰²å—,æˆ‘ä»¬ä½¿ç”¨éšæœºç”Ÿæˆçš„é¢œè‰²ä½œä¸ºè‰²å—çš„å¡«å……è‰²
    context.fillStyle = '#'+Math.floor(Math.random()*16777215).toString(16)
    // è¿™é‡Œéœ€è¦ä½¿ç”¨moveToæ–¹æ³•å°†åˆå§‹ä½ç½®å®šä½åœ¨åœ†ç‚¹å¤„,è¿™æ ·ç»˜åˆ¶çš„åœ†
    // å¼§éƒ½ä¼šä»¥åœ†ç‚¹ä½œä¸ºé—­åˆç‚¹,ä¸‹é¢æœ‰ä½¿ç”¨moveToå’Œä¸ä½¿ç”¨moveToçš„å¯¹æ¯”å›¾
    context.moveTo(150, 150)
    // ç”»åœ†å¼§æ—¶,æ¯æ¬¡éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨moveTo,å°†ç”»ç¬”ç§»åŠ¨åˆ°åœ†å¼§çš„èµ·ç‚¹,åŠ
    // å¾„æˆ‘ä»¬è®¾ç½®çš„æ¯”è½¬ç›˜ç¨å°ä¸€ç‚¹
    context.arc(150, 150, 140, startRadian, endRadian, false)
    // æ¯ä¸ªå¥–å“è‰²å—ç»˜åˆ¶å®Œå,ä¸‹ä¸ªå¥–å“çš„å¼§åº¦ä¼šé€’å¢
    startRadian += RadianGap
    endRadian += RadianGap
    context.fill()
    context.restore()
  }
}
// modify
render() {
  this.drawPanel()
  this.drawPrizeBlock()
}
```

ä¿å­˜å,æˆ‘ä»¬çš„è½¬ç›˜å˜ä¸ºå¦‚ä¸‹å›¾æ ·å¼:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/166730141b370137?w=887&h=451&f=png&s=24686)

ä½¿ç”¨ç»˜åˆ¶å¥–å“è‰²å—ä½¿ç”¨`context.moveTo(150, 150)`å’Œä¸ä½¿ç”¨çš„åŒºåˆ«:

ä½¿ç”¨äº†`context.moveTo(150, 150)`:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/1667307ebb51d650?w=887&h=451&f=png&s=37248)

æ²¡æœ‰ä½¿ç”¨`context.moveTo(150, 150)`:
  
![](https://user-gold-cdn.xitu.io/2018/10/14/166730ae7602e398?w=887&h=451&f=png&s=36050)

å¥–å“å—ç»˜åˆ¶å¥½äº†,æˆ‘ä»¬éœ€è¦æ·»åŠ æ¯ä¸ªå¥–å“çš„åç§°,å‡å®šæˆ‘ä»¬æœ‰ä¸‰ä¸ªå¥–å“,å¦å¤–ä¸‰ä¸ªå°±è®¾ç½®ä¸ºæœªä¸­å¥–

`turntable.jsx`æ–‡ä»¶ä¸­å†…å®¹æ”¹å˜å¦‚ä¸‹:

```javascript
constructor(options) {
  this.canvas = options.canvas
  this.context = options.context
  // add åˆå§‹åŒ–æ—¶æ·»åŠ äº†å¥–å“çš„é…ç½®
  this.awards = [
    { level: 'ç‰¹ç­‰å¥–', name: 'æˆ‘çš„äº²ç¬”ç­¾å', color: '#576c0a' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#ad4411' },
    { level: 'ä¸€ç­‰å¥–', name: 'ç›èæ‹‰è’‚è¶…çº§ç»å…¸é™é‡è·‘è½¦', color: '#43ed04' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#d5ed1d' },
    { level: 'äºŒç­‰å¥–', name: 'è¾£æ¡ä¸€åŒ…', color: '#32acc6' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#e06510' },
  ]
}
// add
// æƒ³ä¸€æƒ³,å¦‚æˆ‘ä»¬ä¸€ç­‰å¥–é‚£æ ·,æ–‡å­—ç‰¹åˆ«é•¿çš„,è¶…å‡ºæˆ‘ä»¬çš„å¥–å“å—,è€Œcanvas
// å´ä¸æ˜¯é‚£ä¹ˆæ™ºèƒ½ç»™ä½ æä¾›è‡ªåŠ¨æ¢è¡Œçš„æœºåˆ¶,äºæ˜¯æˆ‘ä»¬åªæœ‰æ‰‹åŠ¨å¤„ç†æ¢è¡Œ
/**
 * 
 * @param {*} context         è¿™ä¸ªå°±ä¸ç”¨è§£é‡Šäº†~
 * @param {*} text            è¿™ä¸ªæ˜¯æˆ‘ä»¬éœ€è¦å¤„ç†çš„é•¿æ–‡æœ¬
 * @param {*} maxLineWidth    è¿™ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸€è¡Œæ–‡æœ¬æœ€å¤§çš„å®½åº¦
 */
// æ•´ä¸ªæ€è·¯å°±æ˜¯å°†æ»¡è¶³æˆ‘ä»¬å®šä¹‰çš„å®½åº¦çš„æ–‡æœ¬ä½œä¸ºvalueå•ç‹¬æ·»åŠ åˆ°æ•°ç»„ä¸­
// æœ€åè¿”å›çš„æ•°ç»„çš„æ¯ä¸€é¡¹å°±æ˜¯æˆ‘ä»¬å¤„ç†åçš„æ¯ä¸€è¡Œäº†.
getLineTextList(context, text, maxLineWidth) {
  let wordList = text.split(''), tempLine = '', lineList = []
  for (let i = 0; i < wordList.length; i++) {
    // measureTextæ–¹æ³•æ˜¯æµ‹é‡æ–‡æœ¬çš„å®½åº¦çš„,è¿™ä¸ªå®½åº¦ç›¸å½“äºæˆ‘ä»¬è®¾ç½®çš„
    // fontSizeçš„å¤§å°,æ‰€ä»¥åŸºäºè¿™ä¸ª,æˆ‘ä»¬å°†maxLineWidthè®¾ç½®ä¸ºå½“å‰å­—ä½“å¤§å°çš„å€æ•°
    if (context.measureText(tempLine).width >= maxLineWidth) {
      lineList.push(tempLine)
      maxLineWidth -= context.measureText(text[0]).width
      tempLine = ''
    }
    tempLine += wordList[i]
  }
  lineList.push(tempLine)
  return lineList
}
// modify 
drawPrizeBlock() {
  const context = this.context
  const awards = this.awards
  let startRadian = 0, RadianGap = Math.PI * 2 / 6, endRadian = startRadian + RadianGap
  for (let i = 0; i < awards.length; i++) {
    context.save()
    context.beginPath()
    context.fillStyle = awards[i].color
    context.moveTo(150, 150)
    context.arc(150, 150, 140, startRadian, endRadian, false)
    context.fill()
    context.restore()
    // å¼€å§‹ç»˜åˆ¶æˆ‘ä»¬çš„æ–‡å­—
    context.save();
    // è®¾ç½®æ–‡å­—é¢œè‰²
    context.fillStyle = '#FFFFFF';
    // è®¾ç½®æ–‡å­—æ ·å¼
    context.font = "14px Arial";
    // æ”¹å˜canvasåŸç‚¹çš„ä½ç½®,ç®€å•æ¥è¯´,translateåˆ°å“ªä¸ªåæ ‡ç‚¹,é‚£ä¹ˆé‚£ä¸ªåæ ‡ç‚¹å°±å°†å˜ä¸ºåæ ‡(0, 0)
    context.translate(
      150 + Math.cos(startRadian + RadianGap / 2) * 140,
      150 + Math.sin(startRadian + RadianGap / 2) * 140
    );
    // æ—‹è½¬è§’åº¦,è¿™ä¸ªæ—‹è½¬æ˜¯ç›¸å¯¹äºåŸç‚¹è¿›è¡Œæ—‹è½¬çš„.
    context.rotate(startRadian + RadianGap / 2 + Math.PI / 2);
    // è¿™é‡Œå°±æ˜¯æ ¹æ®æˆ‘ä»¬è·å–çš„å„è¡Œçš„æ–‡å­—è¿›è¡Œç»˜åˆ¶,maxLineWidthæˆ‘ä»¬å–70,ç›¸å½“ä¸
    // ä¸€è¡Œæˆ‘ä»¬æœ€å¤šå±•ç¤º5ä¸ªæ–‡å­—
    this.getLineTextList(context, awards[i].name, 70).forEach((line, index) => {
      // ç»˜åˆ¶æ–‡å­—çš„æ–¹æ³•,ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¸¦åˆ«:è¦ç»˜åˆ¶çš„æ–‡å­—,å¼€å§‹ç»˜åˆ¶çš„xåæ ‡,å¼€å§‹ç»˜åˆ¶çš„yåæ ‡
      context.fillText(line, -context.measureText(line).width / 2, ++index * 25);
    })
    context.restore();

    startRadian += RadianGap
    endRadian += RadianGap
  }
}
```

ä¿å­˜å,æˆ‘ä»¬è½¬ç›˜å˜æˆå¦‚ä¸‹æ¨¡æ ·:
  
![](https://user-gold-cdn.xitu.io/2018/10/15/1667861365645186?w=887&h=451&f=png&s=48853)

#### 1.3.ç»˜åˆ¶æŒ‰é’®ä¸ç®­å¤´

`Turntable`ç±»æ·»åŠ å’Œä¿®æ”¹å†…å®¹å¦‚ä¸‹:

```javascript
// add
// ç»˜åˆ¶æŒ‰é’®ï¼Œä»¥åŠæŒ‰é’®ä¸Šstartçš„æ–‡å­—ï¼Œè¿™é‡Œæ²¡æœ‰æ–°çš„ç‚¹ï¼Œä¸å†èµ˜è¿°
drawButton() {
  const context = this.context
  context.save()
  context.beginPath()
  context.fillStyle = '#FF0000'
  context.arc(150, 150, 30, 0, Math.PI * 2, false)
  context.fill()
  context.restore()
  
  context.save()
  context.beginPath()
  context.fillStyle = '#FFF'
  context.font = '20px Arial'
  context.translate(150, 150)
  context.fillText('Start', -context.measureText('Start').width / 2, 8)
  context.restore()
}
// add
// ç»˜åˆ¶ç®­å¤´ï¼Œç”¨æ¥æŒ‡å‘æˆ‘ä»¬æŠ½ä¸­çš„å¥–å“
drawArrow() {
  const context = this.context
  context.save()
  context.beginPath()
  context.fillStyle = '#FF0000'
  context.moveTo(140, 125)
  context.lineTo(150, 100)
  context.lineTo(160, 125)
  context.closePath()
  context.fill()
  context.restore()
}
render() {
  this.drawPanel()
  this.drawPrizeBlock()
  this.drawButton()
  this.drawArrow()
}
```

ä¿å­˜åï¼Œè½¬ç›˜å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
  
![](https://user-gold-cdn.xitu.io/2018/10/16/1667d96bd509b2ed?w=887&h=451&f=png&s=27442)

#### 1.4.ç‚¹å‡»æŒ‰é’®ï¼Œè®©è½¬ç›˜è½¬åŠ¨èµ·æ¥

æ•ˆæœåº”è¯¥æ˜¯ï¼šå½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ—¶ï¼ŒæŒ‰é’®å’ŒæŒ‡é’ˆä¿æŒä¸åŠ¨ï¼Œè€Œè½¬ç›˜ä»¥åŠè½¬ç›˜ä¸Šçš„å¥–å“å—ä¼šåŒæ—¶æ—‹è½¬èµ·æ¥ã€‚

è€Œå¦‚ä½•è®©è½¬ç›˜æ—‹è½¬èµ·æ¥å‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬æ˜¯å¦‚ä½•ç»˜åˆ¶è½¬ç›˜å’Œå¥–å“å—çš„å—ï¼Œæˆ‘ä»¬æ˜¯ä»¥ç»˜åˆ¶å¼§çš„æ–¹å¼ï¼Œä»è§’åº¦ä¸º0çš„ä½ç½®å¼€å§‹ç»˜åˆ¶ï¼Œå¦‚æœæˆ‘ä»¬å°†ç»˜åˆ¶çš„å¼€å§‹è§’åº¦å¢åŠ ä¸€ç‚¹ï¼Œé‚£ä¹ˆè½¬ç›˜çš„ä½ç½®å°±ç›¸å½“ä¸è½¬åŠ¨äº†ä¸€ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å½“æˆ‘ä»¬ä¸åœçš„æ”¹å˜å¼€å§‹è§’åº¦æ—¶ï¼Œè½¬ç›˜çœ‹èµ·æ¥å°±åƒæ˜¯æ—‹è½¬äº†ã€‚

`Turntable`ç±»ä¸­å†…å®¹ä¿®æ”¹å¦‚ä¸‹ï¼š

```javascript
// modify
constructor(options) {
  this.canvas = options.canvas
  this.context = options.context
  // æ·»åŠ äº†è¿™ä¸ªå±æ€§ï¼Œæ¥è®°å½•æˆ‘ä»¬çš„åˆå§‹è§’åº¦
  this.startRadian = 0
  this.awards = [
    { level: 'ç‰¹ç­‰å¥–', name: 'æˆ‘çš„äº²ç¬”ç­¾å', color: '#576c0a' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#ad4411' },
    { level: 'ä¸€ç­‰å¥–', name: 'ç›èæ‹‰è’‚è¶…çº§ç»å…¸é™é‡è·‘è½¦', color: '#43ed04' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#d5ed1d' },
    { level: 'äºŒç­‰å¥–', name: 'è¾£æ¡ä¸€åŒ…', color: '#32acc6' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#e06510' },
  ]
}
// modify
drawPanel() {
  const context = this.context
  const startRadian = this.startRadian
  context.save()
  context.beginPath()
  context.fillStyle = '#FD6961'
  // æ ¹æ®æˆ‘ä»¬è®¾å®šçš„åˆå§‹è§’åº¦æ¥ç»˜åˆ¶è½¬ç›˜
  context.arc(150, 150, 150, startRadian, Math.PI * 2 + startRadian, false)
  context.fill()
  context.restore()
}
// modify
drawPrizeBlock() {
  const context = this.context
  const awards = this.awards
  // æ ¹æ®åˆå§‹è§’åº¦æ¥ç»˜åˆ¶å¥–å“å—
  let startRadian = this.startRadian, RadianGap = Math.PI * 2 / 6, endRadian = startRadian + RadianGap
  for (let i = 0; i < awards.length; i++) {
    context.save()
    context.beginPath()
    context.fillStyle = awards[i].color
    context.moveTo(150, 150)
    context.arc(150, 150, 140, startRadian, endRadian, false)
    context.fill()
    context.restore()

    context.save()
    context.fillStyle = '#FFF'
    context.font = "14px Arial"
    context.translate(
      150 + Math.cos(startRadian + RadianGap / 2) * 140,
      150 + Math.sin(startRadian + RadianGap / 2) * 140
    )
    context.rotate(startRadian + RadianGap / 2 + Math.PI / 2)
    this.getLineTextList(context, awards[i].name, 70).forEach((line, index) => {
      context.fillText(line, -context.measureText(line).width / 2, ++index * 25)
    })
    context.restore()

    startRadian += RadianGap
    endRadian += RadianGap
  }
}
// add
// è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºäº†å°†canvaså†windowä¸­çš„åæ ‡ç‚¹è½¬åŒ–ä¸ºcanvasä¸­çš„åæ ‡ç‚¹
windowToCanvas(canvas, e) {
  // getBoundingClientRectè¿™ä¸ªæ–¹æ³•è¿”å›htmlå…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹äºè§†å£çš„ä½ç½®
  const canvasPostion = canvas.getBoundingClientRect(), x = e.clientX, y = e.clientY
  return {
    x: x - canvasPostion.left,
    y: y - canvasPostion.top
  }
};
// add
// è¿™ä¸ªæ–¹æ³•å°†ä½œä¸ºçœŸæ­£çš„åˆå§‹åŒ–æ–¹æ³•
startRotate() {
  const canvas = this.canvas
  const context = this.context
  // getAttributeè¿™ä¸ªæ–¹æ³•å¯ä»¥è·å–åˆ°å…ƒç´ çš„å±æ€§å€¼ï¼Œæˆ‘ä»¬è·å–äº†canvasçš„æ ·å¼å°†ä¹‹ä¿å­˜åœ¨canvasStyleå˜é‡ä¸­
  const canvasStyle = canvas.getAttribute('style');
  // è¿™é‡Œç»˜åˆ¶æˆ‘ä»¬åˆå§‹åŒ–æ—¶å€™çš„canvaså…ƒç´ 
  this.render()
  // æ·»åŠ ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æŒ‰é’®åï¼Œæˆ‘ä»¬å¼€å§‹æ—‹è½¬è½¬ç›˜
  canvas.addEventListener('mousedown', e => {
    let postion = this.windowToCanvas(canvas, e)
    context.beginPath()
    // è¿™é‡Œæ˜¯åœ¨æŒ‰é’®åŒºåŸŸåœ¨æ¬¡ç»˜åˆ¶äº†ä¸€ä¸ªæ²¡æœ‰é¢œè‰²çš„åœ†ï¼Œç„¶ååˆ¤æ–­æˆ‘ä»¬ç‚¹å‡»çš„è½ç‚¹æ˜¯å¦åœ¨è¿™ä¸ªåœ†å†…ï¼Œç›¸å½“äºåˆ¤æ–­æ˜¯å¦ç‚¹å‡»æˆ‘ä»¬çš„æŒ‰é’®
    context.arc(150, 150, 30, 0, Math.PI * 2, false)
    if (context.isPointInPath(postion.x, postion.y)) {
      // ç‚¹å‡»æŒ‰é’®åï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æ”¹å˜æˆ‘ä»¬çš„åˆå§‹è§’åº¦startRadian
      this.rotatePanel()
    }
  })
  // æ·»åŠ é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œä»…ä»…æ˜¯ä¸ºäº†è®¾ç½®é¼ æ ‡æŒ‡é’ˆçš„æ ·å¼
  canvas.addEventListener('mousemove', e => {
    let postion = this.windowToCanvas(canvas, e)
    context.beginPath()
    context.arc(150, 150, 30, 0, Math.PI * 2, false)
    if (context.isPointInPath(postion.x, postion.y)) {
      canvas.setAttribute('style', `cursor: pointer;${canvasStyle}`)
    } else {
      canvas.setAttribute('style', canvasStyle)
    }
  })
}
// add
// å¤„ç†æ—‹è½¬çš„å…³é”®æ–¹æ³•
rotatePanel() {
  // æ¯æ¬¡è°ƒç”¨éƒ½å°†åˆå§‹è§’åº¦å¢åŠ 1åº¦
  this.startRadian += Math.PI / 180
  // åˆå§‹è§’åº¦æ”¹å˜åï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°ç»˜åˆ¶
  this.render()
  // å¾ªç¯è°ƒç”¨rotatePanelå‡½æ•°ï¼Œä½¿å¾—è½¬ç›˜çš„ç»˜åˆ¶è¿ç»­ï¼Œé€ æˆæ—‹è½¬çš„è§†è§‰æ•ˆæœ
  window.requestAnimationFrame(this.rotatePanel.bind(this));
}
// modify
render() {
  this.drawPanel()
  this.drawPrizeBlock()
  this.drawButton()
  this.drawArrow()
}
```

`App.js`å†…å®¹ä¿®æ”¹å¦‚ä¸‹ï¼š

```javascript
// modify
componentDidMount() {
  const canvas = this.canvas.current
  const context = canvas.getContext('2d')
  canvas.width = 300
  canvas.height = 300
  const turntable = new Turntable({ canvas: canvas, context: context })
  // å°†renderæ›¿æ¢ä¸ºè°ƒç”¨startRotate
  turntable.startRotate()
}
```

ä¿å­˜åï¼Œå°†å¦‚ä¸‹å›¾æ“ä½œæ•ˆæœï¼š
  
![](https://user-gold-cdn.xitu.io/2018/10/19/1668cc83e9bf93ea?w=880&h=446&f=gif&s=760863)

å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»ç‚¹å‡»æŒ‰é’®åï¼Œè½¬ç›˜å¼€å§‹ç¼“ç¼“çš„æ—‹è½¬äº†ã€‚
  
#### 1.5.è®©è½¬ç›˜ç¼“ç¼“åœç•™åœ¨æˆ‘ä»¬æŒ‡å®šçš„å¥–å“å¤„

`Turntable`ç±»ä¸­å†…å®¹ä¿®æ”¹å¦‚ä¸‹ï¼š

```javascript
// modify
constructor(options) {
  this.canvas = options.canvas
  this.context = options.context
  this.startRadian = 0
  // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªç‚¹å‡»é™åˆ¶ï¼Œè¿™é‡Œä¸ºäº†æ§åˆ¶æŠ½å¥–ä¸­ä¸è®©å†æŠ½å¥–
  this.canBeClick = true
  this.awards = [
    { level: 'ç‰¹ç­‰å¥–', name: 'æˆ‘çš„äº²ç¬”ç­¾å', color: '#576c0a' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#ad4411' },
    { level: 'ä¸€ç­‰å¥–', name: 'ç›èæ‹‰è’‚è¶…çº§ç»å…¸é™é‡è·‘è½¦', color: '#43ed04' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#d5ed1d' },
    { level: 'äºŒç­‰å¥–', name: 'è¾£æ¡ä¸€åŒ…', color: '#32acc6' },
    { level: 'æœªä¸­å¥–', name: 'æœªä¸­å¥–', color: '#e06510' },
  ]
}
// modify
startRotate() {
  const canvas = this.canvas
  const context = this.context
  const canvasStyle = canvas.getAttribute('style');
  this.render()
  canvas.addEventListener('mousedown', e => {
    // åªè¦æŠ½å¥–æ²¡æœ‰ç»“æŸï¼Œå°±ä¸è®©å†æ¬¡æŠ½å¥–
    if (!this.canBeClick) return
    this.canBeClick = false
    let loc = this.windowToCanvas(canvas, e)
    context.beginPath()
    context.arc(150, 150, 30, 0, Math.PI * 2, false)
    if (context.isPointInPath(loc.x, loc.y)) {
      // æ¯æ¬¡ç‚¹å‡»æŠ½å¥–ï¼Œæˆ‘ä»¬éƒ½å°†åˆå§‹åŒ–è§’åº¦é‡ç½®
      this.startRadian = 0
      // distanceæ˜¯æˆ‘ä»¬è®¡ç®—å‡ºçš„å°†æŒ‡å®šå¥–å“æ—‹è½¬åˆ°æŒ‡é’ˆå¤„éœ€è¦æ—‹è½¬çš„è§’åº¦è·ç¦»ï¼ŒdistanceToStopä¸‹é¢ä¼šåˆè¯´æ˜
      const distance = this.distanceToStop()
      this.rotatePanel(distance)
    }
  })
  canvas.addEventListener('mousemove', e => {
    let loc = this.windowToCanvas(canvas, e)
    context.beginPath()
    context.arc(150, 150, 30, 0, Math.PI * 2, false)
    if (context.isPointInPath(loc.x, loc.y)) {
      canvas.setAttribute('style', `cursor: pointer;${canvasStyle}`)
    } else {
      canvas.setAttribute('style', canvasStyle)
    }
  })
}
// modify
rotatePanel(distance) {
  // æˆ‘ä»¬è¿™é‡Œç”¨ä¸€ä¸ªå¾ˆç®€å•çš„ç¼“åŠ¨å‡½æ•°æ¥è®¡ç®—æ¯æ¬¡ç»˜åˆ¶éœ€è¦æ”¹å˜çš„è§’åº¦ï¼Œè¿™æ ·å¯ä»¥è¾¾åˆ°ä¸€ä¸ªè½¬ç›˜ä»å—åˆ°æ…¢çš„æ¸å˜çš„è¿‡ç¨‹
  let changeRadian = (distance - this.startRadian) / 10
  this.startRadian += changeRadian
  // å½“æœ€åæˆ‘ä»¬çš„ç›®æ ‡è·ç¦»ä¸startRadianä¹‹é—´çš„å·®è·ä½äº0.05æ—¶ï¼Œæˆ‘ä»¬å°±é»˜è®¤å¥–å“æŠ½å®Œäº†ï¼Œå¯ä»¥ç»§ç»­æŠ½ä¸‹ä¸€ä¸ªäº†ã€‚
  if (distance - this.startRadian <= 0.05) {
    this.canBeClick = true;
    return
  }
  this.render()
  window.requestAnimationFrame(this.rotatePanel.bind(this, distance))
}
// add
distanceToStop() {
  // middleDegreesä¸ºå¥–å“å—çš„ä¸­é—´è§’åº¦ï¼ˆæˆ‘ä»¬æœ€ç»ˆåœç•™éƒ½æ˜¯ä»¥ä¸­é—´è§’åº¦è¿›è¡Œè®¡ç®—çš„ï¼‰è·ç¦»åˆå§‹çš„startRadiançš„è·ç¦»ï¼Œdistanceå°±æ˜¯å½“å‰å¥–å“è·‘åˆ°æŒ‡é’ˆä½ç½®è¦è½¬åŠ¨çš„è·ç¦»ã€‚
  let middleDegrees = 0, distance = 0
  // æ˜ å°„å‡ºæ¯ä¸ªå¥–å“çš„middleDegrees
  const awardsToDegreesList = this.awards.map((data, index) => {
    let awardRadian = (Math.PI * 2) / this.awards.length
    return awardRadian * index + (awardRadian * (index + 1) - awardRadian * index) / 2
  });
  // éšæœºç”Ÿæˆä¸€ä¸ªç´¢å¼•å€¼ï¼Œæ¥è¡¨ç¤ºæˆ‘ä»¬æ­¤æ¬¡æŠ½å¥–åº”è¯¥ä¸­çš„å¥–å“
  const currentPrizeIndex = Math.floor(Math.random() * this.awards.length)
  console.log('å½“å‰å¥–å“åº”è¯¥ä¸­çš„å¥–å“æ˜¯ï¼š'+this.awards[currentPrizeIndex].name)
  middleDegrees = awardsToDegreesList[currentPrizeIndex];
  // å› ä¸ºæŒ‡é’ˆæ˜¯å‚ç›´å‘ä¸Šçš„ï¼Œç›¸å½“åæ ‡ç³»çš„Math.PI/2,æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¦è¿›è¡Œåˆ¤æ–­æ¥ç§»åŠ¨è§’åº¦
  distance = Math.PI * 3 / 2 - middleDegrees
  distance = distance > 0 ? distance : Math.PI * 2 + distance
  // è¿™é‡Œé¢å¤–åŠ ä¸Šåé¢çš„å€¼ï¼Œæ˜¯ä¸ºäº†è®©è½¬ç›˜å¤šè½¬åŠ¨å‡ åœˆï¼Œçœ‹ä¸Šå»æ›´åƒæ˜¯åœ¨æŠ½å¥–
  return distance + Math.PI * 10;
}
```

ä¿å­˜åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¼€å§‹æŠ½å¥–äº†ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://user-gold-cdn.xitu.io/2018/10/19/1668d07c7626dbdb?w=879&h=447&f=gif&s=2770125)

æ¯”è¾ƒå¹¸è¿ï¼Œç¬¬ä¸€æ¬¡å°±ä¸­äº†ä¸¤ç›èæ‹‰è’‚ğŸ˜€

æ–‡ç« å†™åˆ°è¿™é‡Œå°±å·®ä¸å¤šç»“æŸï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼ˆå·æ‡’ï¼‰ï¼Œæ–‡ç« ä¸­å¾ˆå¤šå‚æ•°éƒ½æ˜¯å†™æ­»çš„ï¼Œå¤§å®¶åœ¨å·¥ä½œä¸­åƒä¸‡åˆ«è¿™ä¹ˆä½œï¼Œè¦è¢«éª‚çš„~~
  
è¿™ä¸ªåªæ˜¯ä¸€ä¸ªéå¸¸éå¸¸ç®€æ˜“çš„è½¬ç›˜ï¼Œè¿˜æœ‰å¾ˆå¤šå¾ˆå¤šåœ°æ–¹å¯ä»¥è¿›è¡Œä¼˜åŒ–å’Œæ‰©å±•ï¼Œæ¯”å¦‚ä¸ºæ¯ä¸ªå¥–å“æ·»åŠ å›¾ç‰‡ï¼Œè½¬ç›˜é¢œè‰²åŠæ¯ä¸ªå¥–å“å—é¢œè‰²å¯é…ç½®ï¼ŒæŒ‡é’ˆè½¬åŠ¨è¿›è¡ŒæŠ½å¥–ï¼Œç¾åŒ–è½¬ç›˜ï¼ˆç¤ºä¾‹çš„è½¬ç›˜é¢œè‰²æ˜¯éšæœºç”Ÿæˆçš„å…­ä¸ªé¢œè‰²ï¼Œæ„Ÿè§‰è¿˜ä¸ä¸‘å“ˆ~~ï¼‰ï¼Œç§»åŠ¨ç«¯é€‚é…ç­‰ç­‰ï¼Œè€ƒéªŒä½ ä»¬çš„æ—¶å€™åˆ°äº†ã€‚
  
æœ€åçš„æœ€åï¼Œå®‰åˆ©ä¸¤éƒ¨å›½æ¼«ï¼Œã€Šæ˜Ÿè¾°å˜ã€‹ï¼Œç»†èŠ‚æ„Ÿäººï¼Œåªæ˜¯å¤ªçŸ­äº†ï¼Œåˆ°ç°åœ¨æ‰3é›†ï¼›å¦ä¸€ä¸ªæ˜¯ã€Šç‹å¦–å°çº¢å¨˜ã€‹ï¼Œè‹è‹çš„é…éŸ³ç®€ç›´èŒåˆ°å¿ƒéƒ½åŒ–äº†ï¼Œbilibiliçœ‹å“¦~

[æºç åœ°å€](https://github.com/binnear/lottery)